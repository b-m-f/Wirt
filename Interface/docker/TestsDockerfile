# APP
FROM rust:alpine as wasm
RUN apk update
RUN apk add nodejs npm  build-base openssl-dev clang curl nginx entr


WORKDIR '/wasm'
ENV NODE_ENV production
COPY shared-libs/rust-wasm .

RUN npm install -g wasm-pack --unsafe-perm=true
RUN npm ci 
RUN npm run build 

FROM node:lts-buster as interface

# Build shared libs
ENV NODE_ENV production
WORKDIR '/shared-libs'
COPY shared-libs .
RUN rm -rf rust-wasm
WORKDIR '/shared-libs/rust-wasm'
COPY --from=wasm /wasm /shared-libs/rust-wasm/
WORKDIR '/shared-libs/crypto'
RUN npm ci
WORKDIR '/shared-libs/config-generators'
RUN npm ci

# build the app
WORKDIR '/app'
COPY Interface/docker/wait-for.sh wait-for.sh
RUN chmod +x wait-for.sh
COPY Interface/package.json  .
COPY Interface/package-lock.json .
RUN npm ci

COPY Interface/src src 
COPY Interface/babel.config.js .
COPY Interface/vue.config.js .
COPY Interface/public public
COPY Interface/.env .
RUN npm run build


COPY Interface/tests tests
COPY Interface/nightwatch.conf.js .
COPY Interface/jest.config.js jest.config.js
COPY Interface/docker/nginx/test.conf /etc/nginx/nginx.conf

RUN mkdir -p /run/nginx

CMD ["nginx", "-g", "daemon off;"]